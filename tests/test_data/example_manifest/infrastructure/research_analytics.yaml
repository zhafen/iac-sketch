research_analytics_infrastructure:
- description: >
    The infrastructure to support Research Analytics operations, which is embedded
    within the Northwestern Medicine Enterprise Data Warehouse.
- infrastructure

data_request_workflow:
- satisfies: can_deliver_data_for_a_given_request
- links: |
    accept_and_process_request --> build_request_data_products
    build_request_data_products --> make_request_data_products_available

accept_and_process_request_workflow:
- satisfies: can_accept_and_process_request
- links:
    value: |
        accept_intake_form --> assign_analyst
        assign_analyst --> complete_service_agreement
        assign_analyst --> complete_data_steward_approval
        complete_service_agreement --> prepare_request_for_work
        complete_data_steward_approval --> prepare_request_for_work
    link_type: depended_on_by
- logic: |
    request = accept_intake_form(request_concept)
    request = assign_analyst(request)
    if request.irb_number is not NULL:
        await has_ds_approval: bool = complete_data_steward_approval(request)
    else:
        has_ds_approval = True
    await has_service_agreement: bool = complete_service_agreement(request)
    if has_ds_approval and has_service_agreement:
        return request
    else:
        request = close_request(request)
        return request

accept_intake_form:
- task
- input:
    requester [requester]:
    study [study]:
- output:
    data_request [data_request]: The request, with details added by the intake form.

assign_analyst:
- task
- input:
    data_request [data_request]:
- output:
    data_request [data_request]:
        - modified_fields:
            has_data_steward_approval:
            has_completed_service_agreement:

complete_data_steward_approval:
- links:
    value: |
      has_irb -->|True| submit_for_data_steward_approval
      has_irb -->|False| return True
      submit_data_steward_approval -> wait_for_data_steward_approval 
      wait_for_data_steward_approval -> has_data_steward_approval
      has_data_steward_approval ->|True| 

build_request_data_products_workflow:
- satisfies: can_build_request_data_products
- links: |
    prepare_request_for_work -> build_cohort_notebook
