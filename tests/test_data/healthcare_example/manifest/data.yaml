patient:
- description: Central entity all care and analysis is centered around.
- fields:
    patient_id [str]: >
        The unique identifier for the patient, in combination with patient_id_type.
    patient_id_type [categorical]:
        categories:
            - nm_bi.ir_id
            - clarity.pat_id
            - mock.mock_id
- primary_key: patient_id
- primary_key: patient_id_type
- time_dependent

time_dependent:
- description: Indicates the owner entity has some level of time dependence.
- fields:
    scd_type [str]:
        description: Slowly changing dimension type.
        categories:
            - Type 0
            - Type 1
            - Type 2
            - Type 3
            - Type 4

cohort:
- description: A group of patients for a study.
- fields:
    report_id [str]: Unique ID for a cohort.
    patients [list[str]]: IDs of patients in the cohort.
    is_active [bool]: Cohorts become active after a specific time and de-activate later.

cohort_patients:
- description: >
    Normalized version of a cohort, in the form of a crosswalk between
    cohort and patient. This is technically Type II, but we routinely archive to keep
    the data size small.
- transformation_of: cohort
- fields:
    report_id [str]:
    patient_id [str]:
    patient_id_type [str]:
    meta_updated_datetime [timestamp]: Time at which this entry was added.
- foreign_keys:
    report_id: report.report_id
    patient_id: patient.patient_id
    patient_id_type: patient.patient_id_type
- time_dependent:
    scd_type: Type II

cohort_patient_change:
- component:
    table: cohort_patients_history
- description: >
    Only stores changes to cohort, which reduces the amount of data stored.
- transformation_of: cohort
- fields:
    report_id [report_id]:
    patient_id [str]:
    patient_id_type [str]:
    change_type [categorical]:
        categories:
            - inserted
            - deleted
    change_datetime [timestamp]: When the change occurred.
- time_dependent:
    scd_type: Type IV

data_request:
- fields:
    snow_universal_request_number [str]: SNow number for the overall task.
    snow_data_steward_approval_task_number [str]: SNow number for data steward approval.
    snow_service_agreement_task_number [str]: SNow number for the service agreement.
    requester_id [str]: This will either be an NU ID via B2B or an NM ID.
    irb_number [str]: Unless this is for de-identified data.
    request_details [str]: As provided by the requester.
    azdo_id [str]:
    assigned_to [str]:
- foreign_keys:
    requester_id: nm_compatible_identity.nm_id
    azdo_id: azdo_work_item.id
    assigned_to: nm_account.nm_id

report:
- description: >
    A report is a set of code, tables, etc. generated in response to a request.
- fields:
    report_id [str]: ID for the report, {irb_number}.{irb_rank:.02d} (e.g. STU001234.01)
    irb_number [str]: IRB number for the study associated with the report.
    irb_rank [int]: >
        IRB rank is defined as the number of reports associated with a study at
        the time of request intake, counting the report itself. As such, IRB rank
        starts at 1 and increases in steps of 1. When doing a partition over irb_number
        ordered by created_date ascending this is the row number.
    pbi_workspace [str]: Which Power BI workspace the report lives in.
    inserted_datetime [timestamp]: >
        Date when the report was created, i.e. the product_id was created and we started
        tracking report status.
    data_steward_approval [bool]: Whether or not the data has been approved for release.
    description [str]: Description for the report.
- primary_key: product_id

report_configuration:
- description: A specific configuration used when generating a report.
- fields:
    azdo_id [str]: >
        There is one and only one Azure DevOps work item per report configuration.
    report_id [str]: >
        ID of the report the Azure DevOps work item is associated with.
        For reports with IRBs this is based on the IRB number and the number of other
        reports for the same study. For reports without an IRB this is based on the
        Azure DevOps ID of the original work item.
    irb_number [str]: Study number if provided, e.g. STU00000000.
    assigned_to [str]: Individual the work item is assigned to.
    domain [str]: >
        Power BI Domain for the report. Also used when specifying the location of the
        report code in the reports repo.
    workspace [str]: >
        Power BI workspace for the report. Also used when specifying the location of
        the report code in the reports repo.
    workspace_folder [str]: >
        Folder in the Power BI workspace for the report. Also used when specifying the
        location of the report code in the reports repo.
    report_dir_pattern [str]: >
        Unix filename pattern specifying the directory inside the ra_reports repo that
        contains the report code.
    azdo_title [str]: Title of the work item.
    state [str]: State of the work item, e.g. 'In Progress' or 'Closed'.
    tags [str]: Tags associated with the work item.
    predecessor_azdo_id [str]: >
        Azure DevOps work item ID of a predecessor linked in the work item. If a work
        item has a predecessor that is also a report work item (has the 'Report' tag),
        then the work item is an update to the original report.
    is_active [str]: >
        If True, then this report is actively refreshed, using the metadata specified
        by this row. Each work item associated with a report can have an 'is_active'
        field in the yaml metadata, but only the most recent active work item (largest
        azdo_id with is_active == True) will be marked as active in this config table.
        When not specified, is_active defaults to True for work items with
        state == 'Closed'.
    refresh_schedule [str]: Specification of how often the report should be executed.
    irb_is_active [str]: For reports with an IRB, whether or not that IRB is active.
    is_visible [str]: >
        Whether or not any generated data should be visible to the end
        users.
    description [str]: >
        Description field for the work item. Some values have been extracted from her
        , e.g. irb_number.
    is_valid [str]: >
        If False, then some aspect of the work item is incorrectly defined, and this
        work item will not be used in production. Check the error_log field for
        details on the issue.
    error_log [str]: >
        Any recorded details on why a given work item may be invalid for specifying
        report metadata
- foreign_keys:
    azdo_id: data_request_work_item.id
    report_id: report.report_id
- primary_key: azdo_id
- name: reports_config

azdo_work_item:
- fields:
    id [int]: Number assigned to the work item by Azure Dev Ops.
    assigned_to [str]: NM ID of the person the work is assigned to.
    state [str]: State the work item is in.
    tags [list[str]]: Tags associated with the work item.

data_request_work_item:
- component
- description: AzDO work item with a "DataRequest" tag.
- parent: azdo_work_item

worklog:
- description: 7pace timekeeping worklog.
- fields:
    worklog_id [int]:
    azdo_id [int]:
    user_id [str]:
    timestamp [timestamp]:
    duration [float]:
- foreign_keys:
    azdo_id: azdo_work_item.id
    user_id: nm_account.nm_id

report_code_product:
- fields:
    report_id [str]:
    filename [str]:
    notebook_type [categorical]:
        categories:
            - etl
            - cohort
            - report
    git_branch [str]:

irb_report_code_product:
- parent: report_code_product
- path: "ra_reports_repo:reports/{domain}/{workspace}/{workspace_folder}/{report_id}{optional_study_label}/report{irb_rank}{optional_report_label}/{notebook_type}{optional_notebook_label}.py"

noirb_report_code_product:
- parent: report_code_product
- path: "ra_reports_repo:reports/{domain}/{workspace}/{workspace_folder}/{report_id}{optional_report_label}/{notebook_type}{optional_notebook_label}.py"

ra_lib_repo:
- repo:
    url: https://NMHC@dev.azure.com/NMHC/FSM%20Research%20Analytics/_git/ra_lib

ra_reports_repo:
- repo:
    url: https://NMHC@dev.azure.com/NMHC/FSM%20Research%20Analytics/_git/ra_reports

ra_reports_branch:
- fields:
    azdo_id [str]: Work item associated with this branch.
    branch [git_branch]: The git branch component itself.
- foreign_keys:
    azdo_id: data_request_work_item.id

report_table:
- description: Standard data product generated for a report.
- fields:
    report_id [str]:
    label [str]:
        description: Label for distinguishing different tables of the same report.
        default: ""
- path: "databricks_prd:research_dm.reports.{report_id}{table_label}"

sharepoint_report_data_export:
- fields:
    report_id [str]:
    label [str]:
        description: Label for distinguishing different tables of the same report.
        default: ""
- path: "nmnu_teams:nmedw_exports_channel:{report_id}/{report_id}{table_label}.csv"

pbi_report:
- fields:
    report_id [str]:
    description [str]: This description will show up in the portal.

irb_pbi_report:
- parent: pbi_report
- path: "{pbi_workspace}:{workspace_folder}/{report_id}{optional_study_label}/report{irb_rank}{optional_report_label}.pbix"

noirb_pbi_report:
- parent: pbi_report
- path: "{pbi_workspace}:{workspace_folder}/{report_id}{optional_report_label}.pbix"

pbi_app_homepage:
- description: >
    Very helpful if this exists for each app for deployment purposes.